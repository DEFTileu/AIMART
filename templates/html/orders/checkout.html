{% load humanize %}
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIMART - –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #0a0a0a;
        color: #ffffff;
        min-height: 100vh;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        width: 100%;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 0 8px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .logo {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #888;
        font-size: 14px;
      }

      .checkout-layout {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 48px;
        align-items: start;
        min-height: calc(100vh - 200px);
      }

      .main-content {
        display: flex;
        flex-direction: column;
        gap: 32px;
        width: 100%;
      }

      .section {
        background: rgba(255, 255, 255, 0.03);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 32px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .section:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 107, 53, 0.3);
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(255, 107, 53, 0.1);
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .cart-item {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .cart-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .cart-item:hover {
        transform: translateX(8px);
      }

      .item-image {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        flex-shrink: 0;
      }

      .item-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .item-name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #ffffff;
      }

      .item-description {
        color: #888;
        font-size: 0.9rem;
      }

      .item-price {
        font-weight: 700;
        color: #ff6b35;
        font-size: 1.2rem;
        margin-left: auto;
      }

      .sidebar {
        position: sticky;
        top: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        height: fit-content;
        width: 100%;
      }

      .payment-section {
        background: rgba(255, 255, 255, 0.03);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 28px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 24px;
        width: 100%;
      }

      .payment-section:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 107, 53, 0.3);
      }

      .payment-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #ffffff;
      }

      .payment-methods {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
      }

      .payment-method {
        flex: 1;
        padding: 16px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .payment-method.active {
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        border-color: transparent;
        transform: scale(1.02);
        box-shadow: 0 8px 24px rgba(255, 107, 53, 0.3);
      }

      .payment-method:hover:not(.active) {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 107, 53, 0.5);
      }

      .payment-method-icon {
        font-size: 1.5rem;
        margin-bottom: 6px;
        display: block;
      }

      .card-form {
        display: none;
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
      }

      .card-form.active {
        display: block;
      }

      #new-card-form {
        display: none;
        width: 100%;
      }

      #new-card-form.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
        width: 100%;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #ccc;
        font-size: 0.9rem;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: #ffffff;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.08);
        border-color: #ff6b35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
      }

      .form-input::placeholder {
        color: #666;
      }

      .form-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
        width: 100%;
      }

      .kaspi-section {
        display: none;
        text-align: center;
        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .kaspi-section.active {
        display: block;
      }

      .qr-code {
        width: 160px;
        height: 160px;
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        border-radius: 20px;
        margin: 20px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        animation: float 3s ease-in-out infinite;
      }

      .order-summary {
        background: rgba(255, 255, 255, 0.03);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 28px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .order-summary:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 107, 53, 0.3);
      }

      .summary-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #ffffff;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        color: #ccc;
        font-size: 1.1rem;
      }

      .summary-row.total {
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 1.4rem;
        font-weight: 700;
        color: #ffffff;
      }

      .price {
        font-family: "Roboto Mono", monospace;
        font-weight: 600;
      }

      .price.total {
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .btn-primary {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        border: none;
        border-radius: 16px;
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-top: 20px;
        position: relative;
        overflow: hidden;
      }

      .btn-primary::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .btn-primary:hover::before {
        left: 100%;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 36px rgba(255, 107, 53, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .loading-spinner {
        display: none;
        width: 24px;
        height: 24px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 16px auto;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: rgba(20, 20, 20, 0.95);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 24px;
        text-align: center;
        max-width: 480px;
        width: 90%;
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .modal-icon {
        font-size: 3.5rem;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 16px;
        color: #ffffff;
      }

      .modal-description {
        color: #aaa;
        margin-bottom: 28px;
        line-height: 1.5;
      }

      .modal-buttons {
        display: flex;
        gap: 16px;
      }

      .btn-secondary {
        flex: 1;
        padding: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: #ccc;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        color: #ffffff;
      }

      .receipt {
        display: none;
        max-width: 600px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.03);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 32px;
        padding: 48px;
        animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .receipt.active {
        display: block;
      }

      .receipt-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .receipt-title {
        font-size: 2.2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 12px;
      }

      .receipt-date {
        color: #888;
        font-size: 1rem;
      }

      .receipt-items {
        margin-bottom: 32px;
      }

      .receipt-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: #ccc;
      }

      .receipt-item:last-child {
        border-bottom: none;
      }

      .receipt-total {
        background: linear-gradient(135deg, #ff6b35, #ff9500);
        padding: 24px;
        border-radius: 20px;
        text-align: center;
        margin-bottom: 32px;
        font-size: 1.3rem;
        font-weight: 700;
      }

      .receipt-actions {
        display: flex;
        gap: 16px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @media (max-width: 1200px) {
        .container {
          padding: 16px;
        }

        .checkout-layout {
          grid-template-columns: 1fr 380px;
          gap: 32px;
        }
      }

      @media (max-width: 992px) {
        .checkout-layout {
          grid-template-columns: 1fr;
        }

        .sidebar {
          position: static;
          order: -1;
        }

        .payment-section,
        .order-summary {
          max-width: 600px;
          margin-left: auto;
          margin-right: auto;
        }
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          text-align: center;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .payment-methods {
          flex-direction: column;
        }

        .payment-method {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 12px;
        }

        .section,
        .payment-section,
        .order-summary {
          padding: 20px;
        }

        .cart-item {
          flex-direction: column;
          text-align: center;
          gap: 12px;
        }

        .item-price {
          margin-left: 0;
        }
      }

      .hidden {
        display: none !important;
      }

      /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */
      .glow-effect {
        position: relative;
        overflow: hidden;
      }

      .glow-effect::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 107, 53, 0.1) 0%,
          transparent 70%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .glow-effect:hover::after {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">üõí AIMART</div>
        <div class="breadcrumb">–ì–ª–∞–≤–Ω–∞—è ‚Üí –ö–æ—Ä–∑–∏–Ω–∞ ‚Üí –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
      </div>

      <div id="checkout-page">
        <div class="checkout-layout">
          <div class="main-content">
            <div class="section glow-effect">
              <h2 class="section-title">üõçÔ∏è –í–∞—à –∑–∞–∫–∞–∑</h2>

              {% for cart_item in cart_items %}
              <div class="cart-item">
                <div class="item-image">
                  <img
                    src="{{ cart_item.product.main_image.url }}"
                    alt="{{ cart_item.product.name }}"
                    class="cart-item-image"
                    width="100%"
                  />
                </div>
                <div class="item-details">
                  <div class="item-name">{{ cart_item.product.name }}</div>
                </div>
                <div class="item-price price">
                  ‚Ç∏ {{ cart_item.product.price|floatformat:0|intcomma }}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="sidebar">
            <div class="payment-section glow-effect">
              <h3 class="payment-title">üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>

              <div class="payment-methods">
                <div class="payment-method active" data-method="card">
                  <span class="payment-method-icon">üí≥</span>
                  –ö–∞—Ä—Ç–∞
                </div>
                <div class="payment-method" data-method="kaspi">
                  <span class="payment-method-icon">üì±</span>
                  Kaspi
                </div>
              </div>

              <div class="card-form active">
                <div class="form-group">
                  <label class="form-label">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</label>
                  <select
                    class="form-select"
                    id="saved-cards"
                    title="–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–∞—Ä—Ç—É"
                    name="saved_card"
                  >
                    <option value="base">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ</option>
                    <option value="new_card">–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                    {% for card in saved_cards %}
                    <option value="{{ card.id }}">
                      **** {{ card.get_last_four }} ({{card.get_card_type_display }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div id="new-card-form">
                <div class="form-group">
                  <label class="form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                  <input
                    type="text"
                    class="form-input"
                    placeholder="1234 5678 9012 3456"
                    maxlength="19"
                    id="card-number"
                  />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">MM/YY</label>
                    <input
                      type="text"
                      class="form-input"
                      placeholder="12/25"
                      maxlength="5"
                      id="card-expiry"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">CVV</label>
                    <input
                      type="text"
                      class="form-input"
                      placeholder="123"
                      maxlength="3"
                      id="card-cvv"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="order-summary glow-effect">
              <h3 class="summary-title">üìã –ò—Ç–æ–≥–æ</h3>

              <div class="summary-row">
                <span>–¢–æ–≤–∞—Ä—ã ({{ cart_items|length }} —à—Ç.):</span>
                <span class="price">‚Ç∏ {{ total|floatformat:0|intcomma }}</span>
              </div>
              <div class="summary-row">
                <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                <span style="color: #4ade80">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
              </div>
              <div class="summary-row total">
                <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
                <span class="price total"
                  >‚Ç∏ {{ total|floatformat:0|intcomma }}</span
                >
              </div>

              <button class="btn-primary" id="pay-btn">–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑</button>
              <div class="loading-spinner" id="loading-spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const paymentMethods = document.querySelectorAll(".payment-method");
      const cardForm = document.querySelector(".card-form");
      const payBtn = document.getElementById("pay-btn");
      const savedCardsSelect = document.getElementById("saved-cards");
      const newCardForm = document.getElementById("new-card-form");
      const loadingSpinner = document.getElementById("loading-spinner");

      async function loadSavedCards() {
        try {
          const response = await fetch("/orders/get-saved-cards/", {
            method: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            credentials: "same-origin",
          });

          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const data = await response.json();
          if (data.cards && data.cards.length > 0) {
            savedCardsSelect.innerHTML = `
              <option value="base">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ</option>
              <option value="">–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
            `;
            data.cards.forEach((card) => {
              savedCardsSelect.innerHTML += `
                <option value="${card.id}">**** ${card.last_four} (${card.card_type})</option>
              `;
            });
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç:", error);
          const errorMessage = document.createElement("div");
          errorMessage.className = "error-message";
          errorMessage.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã";
          savedCardsSelect.parentNode.appendChild(errorMessage);
        }
      }

      function initializeCardForm() {
        const selectedMethod = document.querySelector(".payment-method.active")
          ?.dataset.method;

        if (selectedMethod === "card") {
          cardForm.classList.add("active");
          const value = savedCardsSelect?.value;
          if (value === "new_card") {
            newCardForm.classList.add("active");
            payBtn.disabled = false;
          } else if (value === "base") {
            newCardForm.classList.remove("active");
            payBtn.disabled = true;
          } else {
            newCardForm.classList.remove("active");
            payBtn.disabled = false;
          }
        } else {
          cardForm.classList.remove("active");
          newCardForm.classList.remove("active");
          payBtn.disabled = false;
        }
      }

      paymentMethods.forEach((method) => {
        method.addEventListener("click", () => {
          paymentMethods.forEach((m) => m.classList.remove("active"));
          method.classList.add("active");
          initializeCardForm();
        });
      });

      savedCardsSelect?.addEventListener("change", () => {
        initializeCardForm();
      });

      const cardNumberInput = document.getElementById("card-number");
      const cardExpiryInput = document.getElementById("card-expiry");

      cardNumberInput?.addEventListener("input", function (e) {
        let value = e.target.value.replace(/\s/g, "").replace(/[^0-9]/gi, "");
        let formattedValue = value.match(/.{1,4}/g)?.join(" ") || value;
        e.target.value = formattedValue;
      });

      cardExpiryInput?.addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length >= 2) {
          value = value.substring(0, 2) + "/" + value.substring(2, 4);
        }
        e.target.value = value;
      });

      function detectCardType(number) {
        const firstDigit = number.charAt(0);
        const firstTwoDigits = number.substring(0, 2);
        if (firstDigit === "4") return "VISA";
        if (["51", "52", "53", "54", "55"].includes(firstTwoDigits))
          return "MASTERCARD";
        if (["34", "37"].includes(firstTwoDigits)) return "AMEX";
        if (["50", "56", "57", "58", "63", "67"].includes(firstTwoDigits))
          return "MAESTRO";
        if (firstTwoDigits === "22") return "MIR";
        return "UNKNOWN";
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      async function processPayment(paymentMethod, cardData = null) {
        try {
          payBtn.disabled = true;
          payBtn.textContent = "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...";
          loadingSpinner.style.display = "block";

          const response = await fetch("/orders/process-payment/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            credentials: "same-origin",
            body: JSON.stringify({
              payment_method: paymentMethod,
              card_data: cardData,
            }),
          });

          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
          const data = await response.json();

          if (data.success) {
            if (paymentMethod === "KASPI") {
              window.location.href = `/orders/kaspi-qr/${data.order_id}/`;
            } else {
              window.location.href = `/orders/waiting/${data.order_id}/`;
            }
          } else {
            throw new Error(data.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞");
          }
        } catch (err) {
          alert("–û—à–∏–±–∫–∞: " + err.message);
        } finally {
          payBtn.disabled = false;
          payBtn.textContent = "–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑";
          loadingSpinner.style.display = "none";
        }
      }

      payBtn?.addEventListener("click", async () => {
        const selectedMethod = document.querySelector(".payment-method.active")
          ?.dataset.method;

        if (selectedMethod === "card") {
          const selectedCard = savedCardsSelect.value;

          if (selectedCard === "base") {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.");
            return;
          }

          if (selectedCard === "") {
            const cardNumber = document.getElementById("card-number").value;
            const cardExpiry = document.getElementById("card-expiry").value;
            const cardCVV = document.getElementById("card-cvv").value;

            if (!cardNumber || !cardExpiry || !cardCVV) {
              alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã");
              return;
            }

            const [expiryMonth, expiryYear] = cardExpiry.split("/");
            const cardData = {
              card_type: detectCardType(cardNumber),
              expiry_month: parseInt(expiryMonth),
              expiry_year: parseInt("20" + expiryYear),
            };

            await processPayment("CARD", cardData);
          } else {
            await processPayment("CARD");
          }
        } else if (selectedMethod === "kaspi") {
          await processPayment("KASPI");
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        initializeCardForm();
        loadSavedCards();

        const sections = document.querySelectorAll(
          ".section, .payment-section, .order-summary"
        );
        sections.forEach((section, index) => {
          section.style.opacity = "0";
          section.style.transform = "translateY(20px)";

          setTimeout(() => {
            section.style.transition = "all 0.6s cubic-bezier(0.4, 0, 0.2, 1)";
            section.style.opacity = "1";
            section.style.transform = "translateY(0)";
          }, index * 100);
        });

        const style = document.createElement("style");
        style.textContent = `
          .error-message {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
          }
        `;
        document.head.appendChild(style);
      });
    </script>
  </body>
</html>
