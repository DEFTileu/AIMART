{% extends 'html/base.html' %} {% load static %} {% block title %}Профиль
продавца - AIMART{% endblock %} {% block extra_css %}
<style>
  .seller-container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
  }

  .profile-header {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 25px;
    background: #e0e0e0;
    flex-shrink: 0;
  }

  .profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-info {
    flex-grow: 1;
  }

  .profile-name {
    font-size: 28px;
    margin: 0 0 5px;
    color: #333;
  }

  .profile-email {
    font-size: 16px;
    color: #666;
    margin: 0 0 10px;
  }

  .profile-type {
    display: inline-block;
    background: #ff8c00;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 14px;
    margin-bottom: 10px;
  }

  .profile-stats {
    display: flex;
    gap: 20px;
    margin-top: 15px;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f8f8f8;
    padding: 10px 15px;
    border-radius: 8px;
  }

  .stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #ff8c00;
  }

  .stat-label {
    font-size: 14px;
    color: #666;
  }

  .tab-navigation {
    margin-bottom: 20px;
    display: flex;
    border-bottom: 1px solid #ddd;
  }

  .tab-button {
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 16px;
    color: #666;
    transition: all 0.3s;
  }

  .tab-button.active {
    color: #ff8c00;
    border-bottom-color: #ff8c00;
    font-weight: 600;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .product-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .product-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s, box-shadow 0.3s;
    position: relative;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .product-status {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 30px;
    font-size: 12px;
    color: white;
    z-index: 1;
  }

  .status-active {
    background: #4caf50;
  }

  .status-inactive {
    background: #f44336;
  }

  .product-image {
    height: 180px;
    width: 100%;
    object-fit: cover;
  }

  .product-info {
    padding: 15px;
  }

  .product-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 42px;
  }

  .product-price {
    font-size: 18px;
    font-weight: 700;
    color: #ff8c00;
    margin-bottom: 15px;
  }

  .product-actions {
    display: flex;
    justify-content: space-between;
  }

  .product-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
    text-decoration: none;
    text-align: center;
    font-size: 14px;
  }

  .btn-edit {
    background: #f8f8f8;
    color: #333;
    flex-grow: 1;
    margin-right: 8px;
  }

  .btn-edit:hover {
    background: #e5e5e5;
  }

  .btn-delete {
    background: #fff0ee;
    color: #f44336;
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-delete:hover {
    background: #fde0db;
  }

  .empty-products {
    text-align: center;
    padding: 40px 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .empty-products h3 {
    font-size: 20px;
    color: #333;
    margin-bottom: 15px;
  }

  .empty-products p {
    color: #666;
    margin-bottom: 20px;
  }

  .add-product-btn {
    display: inline-block;
    padding: 12px 24px;
    background: #ff8c00;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    transition: background 0.3s;
  }

  .add-product-btn:hover {
    background: #e67e00;
  }

  .toggle-status {
    cursor: pointer;
    display: flex;
    align-items: center;
    margin-top: 8px;
    font-size: 14px;
    color: #777;
  }

  .toggle-status input {
    margin-right: 8px;
  }

  .product-form {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .form-title {
    font-size: 22px;
    color: #333;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
  }

  .form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border-color 0.3s;
  }

  .form-control:focus {
    border-color: #ff8c00;
    outline: none;
  }

  .form-text {
    font-size: 13px;
    color: #777;
    margin-top: 5px;
  }

  .image-preview {
    width: 100%;
    height: 200px;
    border: 1px dashed #ddd;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  .submit-btn {
    padding: 12px 24px;
    background: #ff8c00;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: background 0.3s;
  }

  .submit-btn:hover {
    background: #e67e00;
  }

  .cancel-btn {
    padding: 12px 24px;
    background: #f5f5f5;
    color: #555;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    margin-right: 10px;
  }

  .cancel-btn:hover {
    background: #e5e5e5;
  }

  .form-actions {
    display: flex;
    margin-top: 30px;
  }

  @media (max-width: 768px) {
    .profile-header {
      flex-direction: column;
      text-align: center;
    }

    .profile-avatar {
      margin-right: 0;
      margin-bottom: 15px;
    }

    .profile-stats {
      justify-content: center;
    }

    .product-list {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
  }
</style>
{% endblock %} {% block content %}
<div class="seller-container">
  <div class="profile-header">
    <div class="profile-avatar">
      {% if user.avatar %}
      <img src="{{ user.avatar.url }}" alt="Аватар" />
      {% endif %}
    </div>
    <div class="profile-info">
      <h1 class="profile-name">{{ user.full_name }}</h1>
      <p class="profile-email">{{ user.email }}</p>
      <span class="profile-type">{{ user.get_user_type_display }}</span>

      <div class="profile-stats">
        <div class="stat-item">
          <span class="stat-value">{{ products_count }}</span>
          <span class="stat-label">Товаров</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ active_products_count }}</span>
          <span class="stat-label">Активно</span>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-navigation">
    <button class="tab-button active" data-tab="products">Мои товары</button>
    <button class="tab-button" data-tab="new-product">Добавить товар</button>
  </div>

  <div id="products" class="tab-content active">
    {% if products %}
    <div class="product-list">
      {% for product in products %}
      <div class="product-card">
        <div
          class="product-status {% if product.is_active %}status-active{% else %}status-inactive{% endif %}"
        >
          {% if product.is_active %}Активен{% else %}Неактивен{% endif %}
        </div>
        {% if product.image_main %}
        <img
          src="{{ product.image_main.url }}"
          alt="{{ product.name }}"
          class="product-image"
        />
        {% else %}
        <div
          class="product-image"
          style="
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <span>Нет фото</span>
        </div>
        {% endif %}
        <div class="product-info">
          <h3 class="product-name">{{ product.name }}</h3>
          <div class="product-price">{{ product.price }} KZT</div>
{#          <div class="product-actions">#}
{#            <a#}
{#              href="{% url 'edit_product' product.id %}"#}
{#              class="product-btn btn-edit"#}
{#              >Редактировать</a#}
{#            >#}
{#            <button#}
{#              class="product-btn btn-delete"#}
{#              data-product-id="{{ product.id }}"#}
{#            >#}
{#              ×#}
{#            </button>#}
{#          </div>#}
          <label class="toggle-status">
            <input
              type="checkbox"
              class="status-toggle"
              data-product-id="{{ product.id }}"
              {%
              if
              product.is_active
              %}checked{%
              endif
              %}
            />
            Товар активен
          </label>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-products">
      <h3>У вас пока нет товаров</h3>
      <p>Добавьте свой первый товар, чтобы начать продажи</p>
      <button class="add-product-btn" data-tab="new-product">
        Добавить товар
      </button>
    </div>
    {% endif %}
  </div>

  <div id="new-product" class="tab-content">
    <form
      method="post"
      action="{% url 'add_product' %}"
      enctype="multipart/form-data"
      class="product-form"
    >
      {% csrf_token %}
      <h2 class="form-title">Добавление нового товара</h2>

      <div class="form-group">
        <label for="product-name" class="form-label">Название товара*</label>
        <input
          type="text"
          id="product-name"
          name="name"
          class="form-control"
          required
        />
      </div>

      <div class="form-group">
        <label for="product-description" class="form-label"
          >Описание товара</label
        >
        <textarea
          id="product-description"
          name="description"
          class="form-control"
          rows="4"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="product-price" class="form-label">Цена*</label>
        <input
          type="number"
          id="product-price"
          name="price"
          step="0.01"
          class="form-control"
          required
        />
        <small class="form-text">Укажите цену в KZT</small>
      </div>

      <div class="form-group">
        <label for="product-image-main" class="form-label"
          >Основное изображение*</label
        >
        <input
          type="file"
          id="product-image-main"
          name="image_main"
          class="form-control"
          accept="image/*"
          required
        />
        <div id="main-image-preview" class="image-preview">
          Предпросмотр изображения
        </div>
      </div>

      <div class="form-group">
        <label for="product-image-optional" class="form-label"
          >Дополнительное изображение</label
        >
        <input
          type="file"
          id="product-image-optional"
          name="image_optional"
          class="form-control"
          accept="image/*"
        />
        <div id="optional-image-preview" class="image-preview">
          Предпросмотр изображения
        </div>
      </div>

      <div class="form-group">
        <label class="toggle-status">
          <input type="checkbox" name="is_active" checked />
          Сделать товар активным сразу после добавления
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" data-tab="products">
          Отмена
        </button>
        <button type="submit" class="submit-btn">Добавить товар</button>
      </div>
    </form>
      {% if form.errors %}
  <div class="form-errors">
    <ul>
      {% for field in form %}
        {% for error in field.errors %}
          <li>{{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Переключение вкладок
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");
    const addProductBtn = document.querySelector(".add-product-btn");

    function switchTab(tabId) {
      tabButtons.forEach((button) => {
        if (button.dataset.tab === tabId) {
          button.classList.add("active");
        } else {
          button.classList.remove("active");
        }
      });

      tabContents.forEach((content) => {
        if (content.id === tabId) {
          content.classList.add("active");
        } else {
          content.classList.remove("active");
        }
      });
    }

    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        switchTab(button.dataset.tab);
      });
    });

    if (addProductBtn) {
      addProductBtn.addEventListener("click", () => {
        switchTab(addProductBtn.dataset.tab);
      });
    }

    // Предпросмотр изображений
    const mainImageInput = document.getElementById("product-image-main");
    const optionalImageInput = document.getElementById(
      "product-image-optional"
    );
    const mainImagePreview = document.getElementById("main-image-preview");
    const optionalImagePreview = document.getElementById(
      "optional-image-preview"
    );

    function setupImagePreview(input, preview) {
      if (!input || !preview) return;

      input.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const reader = new FileReader();

          reader.onload = function (e) {
            preview.innerHTML = "";
            preview.style.backgroundImage = `url('${e.target.result}')`;
          };

          reader.readAsDataURL(this.files[0]);
        } else {
          preview.innerHTML = "Предпросмотр изображения";
          preview.style.backgroundImage = "none";
        }
      });
    }

    setupImagePreview(mainImageInput, mainImagePreview);
    setupImagePreview(optionalImageInput, optionalImagePreview);

    // Изменение статуса товара
    const statusToggles = document.querySelectorAll(".status-toggle");

    statusToggles.forEach((toggle) => {
      toggle.addEventListener("change", function () {
        const productId = this.dataset.productId;
        const isActive = this.checked;

        fetch("/api/products/toggle-status/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            product_id: productId,
            is_active: isActive,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Обновляем статус визуально
              const card = toggle.closest(".product-card");
              const statusBadge = card.querySelector(".product-status");

              if (isActive) {
                statusBadge.classList.remove("status-inactive");
                statusBadge.classList.add("status-active");
                statusBadge.textContent = "Активен";
              } else {
                statusBadge.classList.remove("status-active");
                statusBadge.classList.add("status-inactive");
                statusBadge.textContent = "Неактивен";
              }
            } else {
              alert("Ошибка: " + data.error);
              // Возвращаем переключатель в исходное состояние
              toggle.checked = !isActive;
            }
          })
          .catch((error) => {
            console.error("Ошибка:", error);
            toggle.checked = !isActive;
          });
      });
    });

    // Удаление товара
    const deleteButtons = document.querySelectorAll(".btn-delete");

    deleteButtons.forEach((button) => {
      button.addEventListener("click", function () {
        if (!confirm("Вы уверены, что хотите удалить этот товар?")) {
          return;
        }

        const productId = this.dataset.productId;
        const card = this.closest(".product-card");

        fetch("/api/products/delete/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({
            product_id: productId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Анимация удаления
              card.style.transition = "opacity 0.3s, transform 0.3s";
              card.style.opacity = "0";
              card.style.transform = "scale(0.8)";

              setTimeout(() => {
                card.remove();

                // Проверяем, остались ли еще товары
                const remainingCards =
                  document.querySelectorAll(".product-card");
                if (remainingCards.length === 0) {
                  const productList = document.querySelector(".product-list");
                  const productsTab = document.getElementById("products");

                  // Если товаров не осталось, показываем сообщение
                  if (productList) productList.remove();

                  const emptyProducts = document.createElement("div");
                  emptyProducts.className = "empty-products";
                  emptyProducts.innerHTML = `
                                    <h3>У вас пока нет товаров</h3>
                                    <p>Добавьте свой первый товар, чтобы начать продажи</p>
                                    <button class="add-product-btn" data-tab="new-product">Добавить товар</button>
                                `;

                  productsTab.appendChild(emptyProducts);

                  // Добавляем обработчик для новой кнопки
                  document
                    .querySelector(".add-product-btn")
                    .addEventListener("click", () => {
                      switchTab("new-product");
                    });
                }
              }, 300);
            } else {
              alert("Ошибка: " + data.error);
            }
          })
          .catch((error) => {
            console.error("Ошибка:", error);
          });
      });
    });

    // Получение CSRF токена из cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
