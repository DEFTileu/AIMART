{% extends 'html/base.html' %} {% load static %} {% block title %}Корзина -
AIMART{% endblock %} {% block extra_css %}
<style>
  .cart-container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
  }

  .cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }

  .cart-title {
    font-size: 28px;
    color: #333;
  }

  .clear-cart {
    padding: 8px 15px;
    border: 1px solid #ddd;
    background: #f5f5f5;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
  }

  .clear-cart:hover {
    border-color: #ff8c00;
    color: #ff8c00;
  }

  .cart-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 30px;
  }

  .cart-items {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .cart-summary {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    align-self: flex-start;
  }

  .cart-item {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 20px;
    padding: 20px 0;
    border-bottom: 1px solid #eee;
  }

  .cart-item:last-child {
    border-bottom: none;
  }

  .cart-item-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
  }

  .cart-item-details {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .cart-item-name {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
  }

  .cart-item-price {
    font-size: 18px;
    color: #ff8c00;
    font-weight: 700;
  }

  .cart-item-controls {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: space-between;
  }

  .quantity-control {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
  }

  .quantity-btn {
    width: 36px;
    height: 36px;
    background: #f5f5f5;
    border: none;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.3s;
  }

  .quantity-btn:hover {
    background: #e5e5e5;
  }

  .quantity-input {
    width: 50px;
    height: 36px;
    border: none;
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
    text-align: center;
    font-size: 16px;
  }

  .remove-item {
    color: #ff3b30;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    padding: 5px 0;
  }

  .remove-item:hover {
    text-decoration: underline;
  }

  .summary-title {
    font-size: 20px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    color: #666;
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    font-size: 20px;
    font-weight: 700;
    color: #333;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
  }

  .checkout-btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: #ff8c00;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 25px;
    transition: background 0.3s;
  }

  .checkout-btn:hover {
    background: #e67e00;
  }

  .no-items {
    text-align: center;
    padding: 50px 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .no-items h2 {
    font-size: 24px;
    color: #333;
    margin-bottom: 15px;
  }

  .no-items p {
    font-size: 16px;
    color: #666;
    margin-bottom: 25px;
  }

  .browse-catalog-btn {
    display: inline-block;
    padding: 12px 25px;
    background: #ff8c00;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-weight: 600;
    transition: background 0.3s;
  }

  .browse-catalog-btn:hover {
    background: #e67e00;
  }

  .promo-input {
    display: flex;
    margin-top: 15px;
  }

  .promo-code {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-right: none;
    border-radius: 4px 0 0 4px;
  }

  .apply-promo {
    padding: 10px 15px;
    background: #ff8c00;
    color: white;
    border: none;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    transition: background 0.3s;
  }

  .apply-promo:hover {
    background: #e67e00;
  }

  .applied-promo {
    margin-top: 15px;
    padding: 10px;
    background: #f0f9ff;
    border: 1px solid #d0e7ff;
    border-radius: 4px;
    color: #0077cc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .remove-promo {
    color: #0077cc;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    line-height: 1;
  }

  @media (max-width: 900px) {
    .cart-layout {
      grid-template-columns: 1fr;
    }

    .cart-summary {
      order: -1;
    }
  }

  @media (max-width: 600px) {
    .cart-item {
      grid-template-columns: 80px 1fr;
      grid-template-rows: auto auto;
    }

    .cart-item-image {
      width: 80px;
      height: 80px;
      grid-row: span 2;
    }

    .cart-item-controls {
      grid-column: 2;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="cart-container">
  <div class="cart-header">
    <h1 class="cart-title">Корзина</h1>
    {% if cart_items %}
    <button class="clear-cart" id="clearCart">Очистить корзину</button>
    {% endif %}
  </div>

  {% if cart_items %}
  <div class="cart-layout">
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item" data-item-id="{{ item.id }}">
        {% if item.product.image %}
        <img
          src="{{ item.product.image.url }}"
          alt="{{ item.product.name }}"
          class="cart-item-image"
        />
        {% else %}
        <div
          class="cart-item-image"
          style="
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          <span>Нет фото</span>
        </div>
        {% endif %}

        <div class="cart-item-details">
          <h3 class="cart-item-name">{{ item.product.name }}</h3>
          <div class="cart-item-price">{{ item.product.price }} ₽</div>
        </div>

        <div class="cart-item-controls">
          <div class="quantity-control">
            <button
              class="quantity-btn decrease-quantity"
              data-item-id="{{ item.id }}"
            >
              -
            </button>
            <input
              type="number"
              value="{{ item.quantity }}"
              min="1"
              class="quantity-input"
              data-item-id="{{ item.id }}"
              aria-label="Количество товара"
            />
            <button
              class="quantity-btn increase-quantity"
              data-item-id="{{ item.id }}"
            >
              +
            </button>
          </div>
          <button class="remove-item" data-item-id="{{ item.id }}">
            Удалить
          </button>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="cart-summary">
      <h2 class="summary-title">Сумма заказа</h2>

      <div class="summary-row">
        <span>Товары ({{ cart_items|length }})</span>
        <span>{{ subtotal }} ₽</span>
      </div>

      {% if delivery_cost %}
      <div class="summary-row">
        <span>Доставка</span>
        <span>{{ delivery_cost }} ₽</span>
      </div>
      {% endif %} {% if discount %}
      <div class="summary-row" style="color: #ff8c00">
        <span>Скидка</span>
        <span>-{{ discount }} ₽</span>
      </div>
      {% endif %}

      <div class="summary-total">
        <span>Итого</span>
        <span>{{ total }} ₽</span>
      </div>

      <div class="promo-input">
        <input
          type="text"
          placeholder="Промокод"
          class="promo-code"
          id="promoCode"
        />
        <button class="apply-promo" id="applyPromo">Применить</button>
      </div>

      {% if promo_applied %}
      <div class="applied-promo">
        <span>{{ promo_code }} (-{{ promo_discount }}%)</span>
        <button class="remove-promo" id="removePromo">×</button>
      </div>
      {% endif %}

      <button class="checkout-btn" id="checkout">Оформить заказ</button>
    </div>
  </div>
  {% else %}
  <div class="no-items">
    <h2>Ваша корзина пуста</h2>
    <p>Добавьте товары в корзину, чтобы оформить заказ</p>
    <a href="{% url 'catalog' %}" class="browse-catalog-btn"
      >Перейти в каталог</a
    >
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Увеличение количества товара
    const increaseButtons = document.querySelectorAll(".increase-quantity");
    increaseButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const itemId = this.dataset.itemId;
        const inputElem = document.querySelector(
          `.quantity-input[data-item-id="${itemId}"]`
        );
        let currentValue = parseInt(inputElem.value);
        inputElem.value = currentValue + 1;
        updateQuantity(itemId, currentValue + 1);
      });
    });

    // Уменьшение количества товара
    const decreaseButtons = document.querySelectorAll(".decrease-quantity");
    decreaseButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const itemId = this.dataset.itemId;
        const inputElem = document.querySelector(
          `.quantity-input[data-item-id="${itemId}"]`
        );
        let currentValue = parseInt(inputElem.value);
        if (currentValue > 1) {
          inputElem.value = currentValue - 1;
          updateQuantity(itemId, currentValue - 1);
        }
      });
    });

    // Обработка изменения количества в поле ввода
    const quantityInputs = document.querySelectorAll(".quantity-input");
    quantityInputs.forEach((input) => {
      input.addEventListener("change", function () {
        const itemId = this.dataset.itemId;
        let currentValue = parseInt(this.value);

        // Проверка на валидность ввода
        if (isNaN(currentValue) || currentValue < 1) {
          currentValue = 1;
          this.value = 1;
        }

        updateQuantity(itemId, currentValue);
      });
    });

    // Удаление товара из корзины
    const removeButtons = document.querySelectorAll(".remove-item");
    removeButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const itemId = this.dataset.itemId;
        const cartItem = document.querySelector(
          `.cart-item[data-item-id="${itemId}"]`
        );

        removeFromCart(itemId, cartItem);
      });
    });

    // Очистка корзины
    const clearCartButton = document.getElementById("clearCart");
    if (clearCartButton) {
      clearCartButton.addEventListener("click", function () {
        clearCart();
      });
    }

    // Применение промокода
    const applyPromoButton = document.getElementById("applyPromo");
    if (applyPromoButton) {
      applyPromoButton.addEventListener("click", function () {
        const promoCode = document.getElementById("promoCode").value.trim();
        if (promoCode) {
          applyPromoCode(promoCode);
        }
      });
    }

    // Удаление промокода
    const removePromoButton = document.getElementById("removePromo");
    if (removePromoButton) {
      removePromoButton.addEventListener("click", function () {
        removePromoCode();
      });
    }

    // Оформление заказа


    // Функция обновления количества
    function updateQuantity(itemId, quantity) {
      fetch("/api/cart/update/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          item_id: itemId,
          quantity: quantity,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Обновляем сумму заказа без перезагрузки страницы
            updateCartSummary(data.subtotal, data.total, data.discount);
          } else {
            alert("Ошибка: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Ошибка:", error);
        });
    }

    // Функция удаления товара из корзины
    function removeFromCart(itemId, cartItemElement) {
      fetch("/api/cart/remove/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          item_id: itemId,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Анимация удаления элемента
            cartItemElement.style.transition = "opacity 0.3s, transform 0.3s";
            cartItemElement.style.opacity = "0";
            cartItemElement.style.transform = "translateX(20px)";

            setTimeout(() => {
              cartItemElement.remove();

              // Обновляем сумму заказа
              updateCartSummary(data.subtotal, data.total, data.discount);

              // Проверяем, остались ли товары в корзине
              const remainingItems = document.querySelectorAll(".cart-item");
              if (remainingItems.length === 0) {
                // Если корзина пуста, перезагружаем страницу
                window.location.reload();
              }
            }, 300);
          } else {
            alert("Ошибка: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Ошибка:", error);
        });
    }

    // Функция очистки корзины
    function clearCart() {
      if (!confirm("Вы уверены, что хотите очистить корзину?")) {
        return;
      }

      fetch("/api/cart/clear/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.reload();
          } else {
            alert("Ошибка: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Ошибка:", error);
        });
    }

    // Функция применения промокода
    function applyPromoCode(code) {
      fetch("/api/cart/apply-promo/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          promo_code: code,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Обновляем информацию о скидке и общей сумме
            updateCartSummary(data.subtotal, data.total, data.discount);

            // Добавляем визуальное отображение примененного промокода
            const promoInputContainer = document.querySelector(".promo-input");
            const appliedPromo = document.createElement("div");
            appliedPromo.className = "applied-promo";
            appliedPromo.innerHTML = `
                        <span>${code} (-${data.promo_discount}%)</span>
                        <button class="remove-promo" id="removePromo">×</button>
                    `;

            promoInputContainer.insertAdjacentElement("afterend", appliedPromo);

            // Добавляем обработчик для кнопки удаления промокода
            document
              .getElementById("removePromo")
              .addEventListener("click", function () {
                removePromoCode();
              });

            // Очищаем поле ввода
            document.getElementById("promoCode").value = "";
          } else {
            alert("Ошибка: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Ошибка:", error);
        });
    }

    // Функция удаления промокода
    function removePromoCode() {
      fetch("/api/cart/remove-promo/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Обновляем информацию о скидке и общей сумме
            updateCartSummary(data.subtotal, data.total, 0);

            // Удаляем визуальное отображение промокода
            const appliedPromo = document.querySelector(".applied-promo");
            if (appliedPromo) {
              appliedPromo.remove();
            }
          } else {
            alert("Ошибка: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Ошибка:", error);
        });
    }

    // Функция обновления суммы заказа
    function updateCartSummary(subtotal, total, discount) {
      const subtotalElem = document.querySelector(
        ".summary-row:first-child span:last-child"
      );
      const totalElem = document.querySelector(
        ".summary-total span:last-child"
      );

      if (subtotalElem) {
        subtotalElem.textContent = subtotal + " ₽";
      }

      if (totalElem) {
        totalElem.textContent = total + " ₽";
      }

      // Обновляем информацию о скидке
      let discountElem = document.querySelector(
        '.summary-row[style*="color: #ff8c00"]'
      );

      if (discount > 0) {
        if (!discountElem) {
          // Создаем элемент скидки, если его нет
          const summaryTotal = document.querySelector(".summary-total");
          discountElem = document.createElement("div");
          discountElem.className = "summary-row";
          discountElem.style.color = "#ff8c00";
          discountElem.innerHTML = `
                        <span>Скидка</span>
                        <span>-${discount} ₽</span>
                    `;
          summaryTotal.insertAdjacentElement("beforebegin", discountElem);
        } else {
          // Обновляем существующий элемент
          discountElem.querySelector("span:last-child").textContent =
            "-" + discount + " ₽";
        }
      } else if (discountElem) {
        // Удаляем элемент скидки, если скидки нет
        discountElem.remove();
      }
    }

    // Получение CSRF токена из cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
